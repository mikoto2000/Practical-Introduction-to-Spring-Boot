---
title: エンドポイントを作る
---

# エンドポイントを作る

## 設計

- エンドポイント: `/api/calc-age?birthDay=1990-01-01`
- HTTP メソッド: GET
- クエリパラメータ: `birthDay` (ISO 8601 形式の生年月日、例: 1990-01-01)
- レスポンス形式: JSON
- レスポンス内容: `{ "age": 33 }` (現在の年齢)


## 実装手順

### 1. DTO の作成

1. `src/main/java/dev/mikoto2000/workshop/projectcreate/calcage/dto` ディレクトリに `CalcAgeResponse.java` ファイルを作成
2. 以下のコードを `CalcAgeResponse.java` に追加
   ```java
   package dev.mikoto2000.workshop.projectcreate.calcage.dto;

   import lombok.AllArgsConstructor;
   import lombok.Data;
   import lombok.NoArgsConstructor;

   @AllArgsConstructor
   @Data
   @NoArgsConstructor
   public class CalcAgeResponse {
     private int age;
   }
   ```


### 2. Service クラスの作成

1. `src/main/java/dev/mikoto2000/workshop/projectcreate/calcage/service` ディレクトリに `CalcAgeService.java` ファイルを作成
2. 以下のコードを `CalcAgeService.java` に追加
   ```java
   package dev.mikoto2000.workshop.projectcreate.calcage.service;

   import org.springframework.stereotype.Service;
   import java.time.LocalDate;
   import java.time.Period;

   /**
    * 年齢計算サービスクラス
    */
   @Service
   public class CalcAgeService {

     /**
      * 指定された生年月日から現在の年齢を計算します。
      *
      * @param birthDate 生年月日
      * @return 年齢
      * @throws IllegalArgumentException 無効な生年月日が指定された場合
      */
     public int calculateAge(LocalDate birthDate) {
       LocalDate currentDate = LocalDate.now();
       if (birthDate == null || birthDate.isAfter(currentDate)) {
         throw new IllegalArgumentException("Invalid birth date");
       }
       return Period.between(birthDate, currentDate).getYears();
     }
   }
   ```

#### `@Service` とは

- `@Service` アノテーションは、Spring Framework においてサービス層のクラスを示すために使用される
- サービス層は、ビジネスロジックを実装する場所であり、コントローラー層とデータアクセス層の間の仲介役
- `@Service` アノテーションを付与することで、依存性注入（DI）によって他のクラスから利用できるようにする
    - (依存性注入（DI）によって他のクラスから利用できるクラス = Bean)


#### Bean とは

- Spring コンテナによって管理されるオブジェクトのこと
- `@Service` アノテーションを使用することで、`CalcAgeService` クラスが Spring の Bean として登録される
- これにより、他のクラスから `CalcAgeService` を注入して利用できるようになる
- Spring はアプリケーションの起動時に Bean をスキャンし、必要に応じてインスタンスを生成・管理する
- `@Controller`、`@Repository`、`@Component` などのアノテーションも同様に Bean を定義する(Spring にインスタンスを管理してもらう)ために使用される


### 3. コントローラークラスの作成

1. `src/main/java/dev/mikoto2000/workshop/projectcreate/calcage/controller` ディレクトリに `CalcAgeController.java` ファイルを作成
2. 以下のコードを `CalcAgeController.java` に追加
   ```java
   package dev.mikoto2000.workshop.projectcreate.calcage.controller;

   import dev.mikoto2000.workshop.projectcreate.calcage.dto.CalcAgeResponse;
   import dev.mikoto2000.workshop.projectcreate.calcage.service.CalcAgeService;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.RequestMapping;
   import org.springframework.web.bind.annotation.RequestParam;
   import org.springframework.web.bind.annotation.RestController;

   import java.time.LocalDate;
   import java.time.format.DateTimeParseException;

   @RestController
   @RequestMapping("/api/calc-age")
   public class CalcAgeController {

     private final CalcAgeService calcAgeService;

     @Autowired
     public CalcAgeController(CalcAgeService calcAgeService) {
       this.calcAgeService = calcAgeService;
     }

     @GetMapping
     public CalcAgeResponse calculateAge(@RequestParam("birthDay") LocalDate birthDay) {
       int age = calcAgeService.calculateAge(birthDay);
       return new CalcAgeResponse(age);
     }
   }
   ```


#### `@RestController` とは

- `@RestController` アノテーションは、Spring Framework において RESTful Web サービスのコントローラークラスを示すために使用される
- クライアントからの HTTP リクエストを受け取り、適切なサービスメソッドを呼び出してレスポンスを生成する役割を果たす


#### DI(Dependency Injection)について

- `@Autowired` アノテーションを使用して、Spring コンテナから `CalcAgeService` のインスタンスを自動的に注入
    - これを依存性注入(Dependency Injection, DI)と呼ぶ
- これにより Spring が管理する Bean として `CalcAgeService` を利用できるようになる
- `CalcAgeService` のインスタンスは、Spring が管理するため、コード内で直接インスタンス化する必要がない
- また、DI により、テスト時にモックオブジェクトを注入することも容易になる

Spring が管理する Bean 工場からインスタンスを貰い受けて利用するイメージ。

>[!TIP]
>- コンストラクタの `@Autowired` は省略可能
>- Lombok の `@RequiredArgsConstructor` と組み合わせるとさらにコードを簡潔にできる
>  ```java
>  ...(snip)
>  @RestController
>  @RequestMapping("/api/calc-age")
>  @RequiredArgsConstructor // private final フィールドにに代入するコンストラクタを自動生成
>  public class CalcAgeController {
>
>    private final CalcAgeService calcAgeService;
>
>    @GetMapping("/calc-age")
>    public CalcAgeResponse calculateAge(@RequestParam("birthDay") LocalDate birthDay) {
>  ...(snip)
>  ```

